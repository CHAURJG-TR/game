<!doctype html>
<html lang="zh-TW" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ“´éŸ³å™¨</title>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      box-sizing: border-box;
    }
    
    .volume-bar {
      transition: height 0.1s ease-out;
    }
    
    .pulse {
      animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }
    
    @keyframes pulse {
      0%, 100% {
        opacity: 1;
      }
      50% {
        opacity: 0.5;
      }
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
 </head>
 <body class="h-full">
  <div id="app" class="w-full h-full flex items-center justify-center p-8">
   <div class="max-w-md w-full bg-white rounded-3xl shadow-2xl p-8">
    <h1 id="title" class="text-4xl font-bold text-center mb-8">æ“´éŸ³å™¨</h1>
    <div class="flex justify-center mb-8">
     <svg width="120" height="120" viewbox="0 0 120 120" class="mic-icon"><circle cx="60" cy="60" r="50" fill="#3B82F6" opacity="0.1" /> <path d="M60 30 C50 30, 45 35, 45 45 L45 60 C45 70, 50 75, 60 75 C70 75, 75 70, 75 60 L75 45 C75 35, 70 30, 60 30 Z" fill="#3B82F6" /> <path d="M35 55 C35 55, 35 70, 60 85 C85 70, 85 55, 85 55" stroke="#3B82F6" stroke-width="4" fill="none" stroke-linecap="round" /> <line x1="60" y1="85" x2="60" y2="95" stroke="#3B82F6" stroke-width="4" stroke-linecap="round" /> <line x1="45" y1="95" x2="75" y2="95" stroke="#3B82F6" stroke-width="4" stroke-linecap="round" />
     </svg>
    </div>
    <div id="volumeMeter" class="mb-8 hidden">
     <p class="text-sm font-medium text-gray-700 mb-2 text-center">éŸ³é‡ç­‰ç´š</p>
     <div class="flex items-end justify-center gap-1 h-24">
      <div class="volume-bar w-6 bg-blue-500 rounded-t" style="height: 10%"></div>
      <div class="volume-bar w-6 bg-blue-500 rounded-t" style="height: 10%"></div>
      <div class="volume-bar w-6 bg-blue-500 rounded-t" style="height: 10%"></div>
      <div class="volume-bar w-6 bg-blue-500 rounded-t" style="height: 10%"></div>
      <div class="volume-bar w-6 bg-blue-500 rounded-t" style="height: 10%"></div>
      <div class="volume-bar w-6 bg-green-500 rounded-t" style="height: 10%"></div>
      <div class="volume-bar w-6 bg-green-500 rounded-t" style="height: 10%"></div>
      <div class="volume-bar w-6 bg-yellow-500 rounded-t" style="height: 10%"></div>
      <div class="volume-bar w-6 bg-orange-500 rounded-t" style="height: 10%"></div>
      <div class="volume-bar w-6 bg-red-500 rounded-t" style="height: 10%"></div>
     </div>
    </div>
    <div class="mb-8">
     <h2 id="micLabel" class="text-lg font-semibold mb-3 text-gray-700">ğŸ¤ éº¥å…‹é¢¨æ“´éŸ³</h2>
     <div class="space-y-3"><button id="startBtn" class="w-full py-3 px-6 rounded-xl font-semibold text-lg transition-all duration-200 transform hover:scale-105 active:scale-95"> é–‹å§‹æ“´éŸ³ </button> <button id="stopBtn" class="w-full py-3 px-6 rounded-xl font-semibold text-lg transition-all duration-200 transform hover:scale-105 active:scale-95 hidden"> åœæ­¢æ“´éŸ³ </button>
     </div>
    </div>
    <div class="border-t border-gray-200 pt-6">
     <h2 id="audioLabel" class="text-lg font-semibold mb-3 text-gray-700">ğŸµ éŸ³æª”æ’­æ”¾</h2>
     <div class="mb-4"><input type="file" id="audioFile" accept="audio/*" class="hidden"> <button id="uploadBtn" class="w-full py-3 px-6 rounded-xl font-semibold text-lg transition-all duration-200 transform hover:scale-105 active:scale-95"> ä¸Šå‚³éŸ³æª” </button>
     </div>
     <div id="audioPlayer" class="hidden">
      <div class="bg-gray-50 rounded-lg p-4 mb-3">
       <p id="fileName" class="text-sm font-medium text-gray-700 mb-2 truncate"></p>
       <div class="flex items-center gap-2 mb-3"><span id="currentTime" class="text-xs text-gray-600">0:00</span>
        <div class="flex-1 bg-gray-300 rounded-full h-2 cursor-pointer" id="progressBar">
         <div id="progress" class="bg-blue-500 h-2 rounded-full" style="width: 0%"></div>
        </div><span id="duration" class="text-xs text-gray-600">0:00</span>
       </div>
       <div class="flex items-center gap-3"><span class="text-xl">ğŸ”Š</span> <input type="range" id="volumeSlider" min="0" max="100" value="100" class="flex-1 h-2 bg-gray-300 rounded-full appearance-none cursor-pointer" style="accent-color: #3B82F6;"> <span id="volumeValue" class="text-xs text-gray-600 w-10 text-right">100%</span>
       </div>
      </div>
      <div class="flex gap-3"><button id="playBtn" class="flex-1 py-3 px-6 rounded-xl font-semibold transition-all duration-200 transform hover:scale-105 active:scale-95"> æ’­æ”¾ </button> <button id="pauseBtn" class="flex-1 py-3 px-6 rounded-xl font-semibold transition-all duration-200 transform hover:scale-105 active:scale-95 hidden"> æš«åœ </button>
      </div>
     </div>
    </div>
    <div id="status" class="mt-6 text-center text-sm text-gray-600"></div>
    <div class="mt-6 p-4 bg-gray-50 rounded-lg">
     <p class="text-xs text-gray-600 text-center">ğŸ’¡ æç¤ºï¼šå¯ä½¿ç”¨éº¥å…‹é¢¨æ“´éŸ³æˆ–ä¸Šå‚³éŸ³æª”æ’­æ”¾</p>
    </div>
   </div>
  </div>
  <script>
    const defaultConfig = {
      background_color: '#F3F4F6',
      surface_color: '#FFFFFF',
      text_color: '#1F2937',
      primary_button_color: '#3B82F6',
      secondary_button_color: '#EF4444',
      font_family: 'system-ui',
      font_size: 16,
      title_text: 'æ“´éŸ³å™¨',
      start_button_text: 'é–‹å§‹æ“´éŸ³',
      stop_button_text: 'åœæ­¢æ“´éŸ³',
      upload_button_text: 'ä¸Šå‚³éŸ³æª”',
      play_button_text: 'æ’­æ”¾',
      pause_button_text: 'æš«åœ'
    };

    let audioContext = null;
    let microphone = null;
    let destination = null;
    let analyser = null;
    let animationId = null;
    let audioElement = null;
    let audioSource = null;

    async function onConfigChange(config) {
      const backgroundColor = config.background_color || defaultConfig.background_color;
      const surfaceColor = config.surface_color || defaultConfig.surface_color;
      const textColor = config.text_color || defaultConfig.text_color;
      const primaryButtonColor = config.primary_button_color || defaultConfig.primary_button_color;
      const secondaryButtonColor = config.secondary_button_color || defaultConfig.secondary_button_color;
      const fontFamily = config.font_family || defaultConfig.font_family;
      const fontSize = config.font_size || defaultConfig.font_size;
      
      const titleText = config.title_text || defaultConfig.title_text;
      const startButtonText = config.start_button_text || defaultConfig.start_button_text;
      const stopButtonText = config.stop_button_text || defaultConfig.stop_button_text;
      const uploadButtonText = config.upload_button_text || defaultConfig.upload_button_text;
      const playButtonText = config.play_button_text || defaultConfig.play_button_text;
      const pauseButtonText = config.pause_button_text || defaultConfig.pause_button_text;

      document.getElementById('app').style.backgroundColor = backgroundColor;
      document.querySelector('.max-w-md').style.backgroundColor = surfaceColor;
      
      const title = document.getElementById('title');
      title.textContent = titleText;
      title.style.color = textColor;
      title.style.fontFamily = `${fontFamily}, system-ui, sans-serif`;
      title.style.fontSize = `${fontSize * 2.5}px`;
      
      const startBtn = document.getElementById('startBtn');
      startBtn.textContent = startButtonText;
      startBtn.style.backgroundColor = primaryButtonColor;
      startBtn.style.color = '#FFFFFF';
      startBtn.style.fontFamily = `${fontFamily}, system-ui, sans-serif`;
      startBtn.style.fontSize = `${fontSize * 1.125}px`;
      
      const stopBtn = document.getElementById('stopBtn');
      stopBtn.textContent = stopButtonText;
      stopBtn.style.backgroundColor = secondaryButtonColor;
      stopBtn.style.color = '#FFFFFF';
      stopBtn.style.fontFamily = `${fontFamily}, system-ui, sans-serif`;
      stopBtn.style.fontSize = `${fontSize * 1.125}px`;
      
      const uploadBtn = document.getElementById('uploadBtn');
      uploadBtn.textContent = uploadButtonText;
      uploadBtn.style.backgroundColor = primaryButtonColor;
      uploadBtn.style.color = '#FFFFFF';
      uploadBtn.style.fontFamily = `${fontFamily}, system-ui, sans-serif`;
      uploadBtn.style.fontSize = `${fontSize * 1.125}px`;
      
      const playBtn = document.getElementById('playBtn');
      playBtn.textContent = playButtonText;
      playBtn.style.backgroundColor = '#10B981';
      playBtn.style.color = '#FFFFFF';
      playBtn.style.fontFamily = `${fontFamily}, system-ui, sans-serif`;
      playBtn.style.fontSize = `${fontSize * 1.125}px`;
      
      const pauseBtn = document.getElementById('pauseBtn');
      pauseBtn.textContent = pauseButtonText;
      pauseBtn.style.backgroundColor = '#F59E0B';
      pauseBtn.style.color = '#FFFFFF';
      pauseBtn.style.fontFamily = `${fontFamily}, system-ui, sans-serif`;
      pauseBtn.style.fontSize = `${fontSize * 1.125}px`;
      
      const labels = document.querySelectorAll('#micLabel, #audioLabel');
      labels.forEach(label => {
        label.style.color = textColor;
        label.style.fontFamily = `${fontFamily}, system-ui, sans-serif`;
        label.style.fontSize = `${fontSize * 1.125}px`;
      });
      
      const statusElements = document.querySelectorAll('#status, .text-xs, .text-sm');
      statusElements.forEach(el => {
        el.style.color = textColor;
        el.style.fontFamily = `${fontFamily}, system-ui, sans-serif`;
      });
      
      const svgPath = document.querySelectorAll('.mic-icon path, .mic-icon line');
      svgPath.forEach(el => {
        if (el.hasAttribute('fill')) {
          el.setAttribute('fill', primaryButtonColor);
        }
        if (el.hasAttribute('stroke')) {
          el.setAttribute('stroke', primaryButtonColor);
        }
      });
      
      document.querySelector('.mic-icon circle').setAttribute('fill', primaryButtonColor);
    }

    async function startAmplifier() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ 
          audio: {
            echoCancellation: false,
            noiseSuppression: false,
            autoGainControl: false
          } 
        });
        
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        microphone = audioContext.createMediaStreamSource(stream);
        destination = audioContext.destination;
        
        analyser = audioContext.createAnalyser();
        analyser.fftSize = 256;
        
        gainNode = audioContext.createGain();
        gainNode.gain.value = 1.0;
        
        microphone.connect(analyser);
        microphone.connect(gainNode);
        gainNode.connect(destination);
        
        document.getElementById('startBtn').classList.add('hidden');
        document.getElementById('stopBtn').classList.remove('hidden');
        document.getElementById('volumeMeter').classList.remove('hidden');
        document.getElementById('status').textContent = 'âœ… æ“´éŸ³ä¸­...';
        document.querySelector('.mic-icon').classList.add('pulse');
        
        visualize();
      } catch (error) {
        document.getElementById('status').textContent = 'âŒ ç„¡æ³•å­˜å–éº¥å…‹é¢¨ï¼Œè«‹ç¢ºèªæˆäºˆæ¬Šé™';
      }
    }

    function stopAmplifier() {
      if (microphone) {
        microphone.disconnect();
        microphone = null;
      }
      if (audioContext) {
        audioContext.close();
        audioContext = null;
      }
      if (animationId) {
        cancelAnimationFrame(animationId);
        animationId = null;
      }
      
      document.getElementById('startBtn').classList.remove('hidden');
      document.getElementById('stopBtn').classList.add('hidden');
      document.getElementById('volumeMeter').classList.add('hidden');
      document.getElementById('status').textContent = '';
      document.querySelector('.mic-icon').classList.remove('pulse');
      
      const bars = document.querySelectorAll('.volume-bar');
      bars.forEach(bar => bar.style.height = '10%');
    }

    function visualize() {
      const bufferLength = analyser.frequencyBinCount;
      const dataArray = new Uint8Array(bufferLength);
      const bars = document.querySelectorAll('.volume-bar');
      
      function draw() {
        animationId = requestAnimationFrame(draw);
        analyser.getByteFrequencyData(dataArray);
        
        const step = Math.floor(bufferLength / bars.length);
        bars.forEach((bar, index) => {
          const value = dataArray[index * step];
          const percent = (value / 255) * 100;
          bar.style.height = Math.max(10, percent) + '%';
        });
      }
      
      draw();
    }

    function formatTime(seconds) {
      const mins = Math.floor(seconds / 60);
      const secs = Math.floor(seconds % 60);
      return `${mins}:${secs.toString().padStart(2, '0')}`;
    }

    function handleFileUpload(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      if (audioElement) {
        audioElement.pause();
        audioElement = null;
      }
      
      audioElement = new Audio();
      audioElement.src = URL.createObjectURL(file);
      
      document.getElementById('fileName').textContent = file.name;
      document.getElementById('audioPlayer').classList.remove('hidden');
      document.getElementById('status').textContent = 'âœ… éŸ³æª”å·²è¼‰å…¥';
      
      audioElement.addEventListener('loadedmetadata', () => {
        document.getElementById('duration').textContent = formatTime(audioElement.duration);
      });
      
      audioElement.addEventListener('timeupdate', () => {
        const progress = (audioElement.currentTime / audioElement.duration) * 100;
        document.getElementById('progress').style.width = progress + '%';
        document.getElementById('currentTime').textContent = formatTime(audioElement.currentTime);
      });
      
      audioElement.addEventListener('ended', () => {
        document.getElementById('playBtn').classList.remove('hidden');
        document.getElementById('pauseBtn').classList.add('hidden');
        document.getElementById('status').textContent = 'âœ… æ’­æ”¾å®Œ';
      });
    }

    function playAudio() {
      if (audioElement) {
        audioElement.play();
        document.getElementById('playBtn').classList.add('hidden');
        document.getElementById('pauseBtn').classList.remove('hidden');
        document.getElementById('status').textContent = 'â–¶ï¸ æ’­æ”¾ä¸­...';
      }
    }

    function pauseAudio() {
      if (audioElement) {
        audioElement.pause();
        document.getElementById('playBtn').classList.remove('hidden');
        document.getElementById('pauseBtn').classList.add('hidden');
        document.getElementById('status').textContent = 'â¸ï¸ å·²æš«åœ';
      }
    }

    document.getElementById('startBtn').addEventListener('click', startAmplifier);
    document.getElementById('stopBtn').addEventListener('click', stopAmplifier);
    
    document.getElementById('uploadBtn').addEventListener('click', () => {
      document.getElementById('audioFile').click();
    });
    
    document.getElementById('audioFile').addEventListener('change', handleFileUpload);
    document.getElementById('playBtn').addEventListener('click', playAudio);
    document.getElementById('pauseBtn').addEventListener('click', pauseAudio);
    
    document.getElementById('progressBar').addEventListener('click', (e) => {
      if (audioElement) {
        const rect = e.target.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const percentage = x / rect.width;
        audioElement.currentTime = percentage * audioElement.duration;
      }
    });
    
    document.getElementById('volumeSlider').addEventListener('input', (e) => {
      const volume = e.target.value / 100;
      if (audioElement) {
        audioElement.volume = volume;
      }
      document.getElementById('volumeValue').textContent = e.target.value + '%';
    });
    
    document.getElementById('micVolumeSlider').addEventListener('input', (e) => {
      const volume = e.target.value / 100;
      if (gainNode) {
        gainNode.gain.value = volume;
      }
      document.getElementById('micVolumeValue').textContent = e.target.value + '%';
    });

    if (window.elementSdk) {
      window.elementSdk.init({
        defaultConfig,
        onConfigChange,
        mapToCapabilities: (config) => ({
          recolorables: [
            {
              get: () => config.background_color || defaultConfig.background_color,
              set: (value) => {
                config.background_color = value;
                window.elementSdk.setConfig({ background_color: value });
              }
            },
            {
              get: () => config.surface_color || defaultConfig.surface_color,
              set: (value) => {
                config.surface_color = value;
                window.elementSdk.setConfig({ surface_color: value });
              }
            },
            {
              get: () => config.text_color || defaultConfig.text_color,
              set: (value) => {
                config.text_color = value;
                window.elementSdk.setConfig({ text_color: value });
              }
            },
            {
              get: () => config.primary_button_color || defaultConfig.primary_button_color,
              set: (value) => {
                config.primary_button_color = value;
                window.elementSdk.setConfig({ primary_button_color: value });
              }
            },
            {
              get: () => config.secondary_button_color || defaultConfig.secondary_button_color,
              set: (value) => {
                config.secondary_button_color = value;
                window.elementSdk.setConfig({ secondary_button_color: value });
              }
            }
          ],
          borderables: [],
          fontEditable: {
            get: () => config.font_family || defaultConfig.font_family,
            set: (value) => {
              config.font_family = value;
              window.elementSdk.setConfig({ font_family: value });
            }
          },
          fontSizeable: {
            get: () => config.font_size || defaultConfig.font_size,
            set: (value) => {
              config.font_size = value;
              window.elementSdk.setConfig({ font_size: value });
            }
          }
        }),
        mapToEditPanelValues: (config) => new Map([
          ['title_text', config.title_text || defaultConfig.title_text],
          ['start_button_text', config.start_button_text || defaultConfig.start_button_text],
          ['stop_button_text', config.stop_button_text || defaultConfig.stop_button_text],
          ['upload_button_text', config.upload_button_text || defaultConfig.upload_button_text],
          ['play_button_text', config.play_button_text || defaultConfig.play_button_text],
          ['pause_button_text', config.pause_button_text || defaultConfig.pause_button_text]
        ])
      });
    }

    onConfigChange(defaultConfig);
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9b553f684112b846',t:'MTc2Njk2ODg0My4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
